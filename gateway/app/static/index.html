<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RideNow | Real-time Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8fafc;
      margin: 0;
      padding: 20px;
      color: #222;
    }
    h2 {
      color: #007bff;
    }
    .section {
      background: white;
      border-radius: 12px;
      padding: 15px 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    input, button {
      margin: 5px;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ddd;
    }
    button {
      cursor: pointer;
      background: #007bff;
      color: white;
      border: none;
    }
    button:hover {
      background: #0056b3;
    }
    #log {
      background: #111;
      color: #0f0;
      padding: 10px;
      height: 300px;
      overflow-y: auto;
      border-radius: 6px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h2>üöï RideNow ‚Äî Real-time Dashboard</h2>

  <div class="section">
    <h3>Signup</h3>
    <input id="signupName" placeholder="Name" />
    <input id="signupEmail" placeholder="Email" />
    <input id="signupPassword" type="password" placeholder="Password" />
    <label><input type="checkbox" id="isDriver" /> Is Driver</label>
    <button onclick="signup()">Signup</button>
  </div>

  <div class="section">
    <h3>Login</h3>
    <input id="loginEmail" placeholder="Email" />
    <input id="loginPassword" type="password" placeholder="Password" />
    <button onclick="login()">Login</button>
  </div>

  <div class="section">
    <h3>WebSocket</h3>
    <button onclick="connectWS()">Connect WebSocket</button>
    <p id="wsStatus">Status: ‚ùå Disconnected</p>
  </div>

  <div class="section">
    <h3>Ride Actions</h3>
    <input id="pickup" placeholder="Pickup location" />
    <input id="dropoff" placeholder="Dropoff location" />
    <button onclick="requestRide()">Request Ride</button><br>

    <input id="assignRideId" placeholder="Ride ID to assign" />
    <input id="assignRiderId" placeholder="Rider ID" />
    <button onclick="assignRide()">Assign Ride</button><br>

    <input id="completeRideId" placeholder="Ride ID to complete" />
    <input id="completeRiderId" placeholder="Rider ID" />
    <button onclick="completeRide()">Complete Ride</button><br>

    <hr />
    <button onclick="getMyRides()">Get My Rides</button>
    <button onclick="getAllRides()">Get All Rides</button>
    <input id="rideId" placeholder="Ride ID" />
    <button onclick="getRideById()">Get Ride by ID</button>
  </div>

  <div class="section">
    <h3>Logs</h3>
    <div id="log"></div>
  </div>

  <script>
    let token = null;
    let socket = null;
    const BASE_URL = "http://localhost:8000"; // Update if needed

    function log(msg) {
      const logBox = document.getElementById("log");
      logBox.innerHTML += msg + "<br>";
      logBox.scrollTop = logBox.scrollHeight;
    }

    async function signup() {
      const name = document.getElementById("signupName").value;
      const email = document.getElementById("signupEmail").value;
      const password = document.getElementById("signupPassword").value;
      const isDriver = document.getElementById("isDriver").checked;

      const res = await fetch(`${BASE_URL}/signup`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, email, password, is_driver: isDriver }),
      });
      const data = await res.json();
      log("‚úÖ Signup: " + JSON.stringify(data));
    }

    async function login() {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;

      const res = await fetch(`${BASE_URL}/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password }),
      });

      if (!res.ok) {
        log("‚ùå Login failed: " + res.status);
        return;
      }

      const data = await res.json();
      token = data.access_token;
      log("‚úÖ Logged in. Token stored.");
    }

    function connectWS() {
      if (!token) {
        log("‚ö†Ô∏è Please login first.");
        return;
      }

      // Close existing connection if any
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.close();
      }

      socket = new WebSocket(`ws://localhost:8000/ws?token=${token}`);
      
      socket.onopen = () => {
        document.getElementById("wsStatus").innerText = "Status: ‚úÖ Connected";
        log("üü¢ WebSocket connected! Waiting for welcome message...");
      };
      
      socket.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          log("üì® WS: " + JSON.stringify(msg, null, 2));
          
          // Handle welcome message
          if (msg.event === "connected") {
            log(`‚úÖ Connection confirmed - User ID: ${msg.user_id}, Driver: ${msg.is_driver}`);
          }
        } catch (e) {
          log("‚ö†Ô∏è Failed to parse WS message: " + event.data);
        }
      };
      
      socket.onclose = (event) => {
        document.getElementById("wsStatus").innerText = "Status: ‚ùå Disconnected";
        log(`üî¥ WebSocket disconnected. Code: ${event.code}, Reason: ${event.reason || 'No reason'}`);
        socket = null;
      };
      
      socket.onerror = (err) => {
        log("‚ö†Ô∏è WebSocket error: " + err);
      };
    }

    function sendWS(action, data = {}) {
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        log("‚ö†Ô∏è Connect WebSocket first.");
        return false;
      }
      
      const message = { action, ...data };
      socket.send(JSON.stringify(message));
      log(`‚û°Ô∏è Sent: ${JSON.stringify(message)}`);
      return true;
    }

    function requestRide() {
      const pickup = document.getElementById("pickup").value;
      const dropoff = document.getElementById("dropoff").value;
      
      if (!pickup || !dropoff) {
        log("‚ö†Ô∏è Please enter pickup and dropoff locations");
        return;
      }
      
      sendWS("ride_requested", { pickup, dropoff });
    }

    function assignRide() {
      const ride_id = document.getElementById("assignRideId").value;
      
      if (!ride_id) {
        log("‚ö†Ô∏è Please enter ride ID");
        return;
      }
      
      sendWS("ride_assigned", { ride_id: parseInt(ride_id) });
    }

    function completeRide() {
      const ride_id = document.getElementById("completeRideId").value;
      
      if (!ride_id) {
        log("‚ö†Ô∏è Please enter ride ID");
        return;
      }
      
      sendWS("ride_completed", { ride_id: parseInt(ride_id) });
    }

    async function getMyRides() {
      const res = await fetch(`${BASE_URL}/rides/my`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await res.json();
      log("üßç‚Äç‚ôÇÔ∏è My Rides: " + JSON.stringify(data, null, 2));
    }

    async function getAllRides() {
      const res = await fetch(`${BASE_URL}/rides`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await res.json();
      log("üåç All Rides: " + JSON.stringify(data, null, 2));
    }

    async function getRideById() {
      const rideId = document.getElementById("rideId").value;
      if (!rideId) return log("‚ö†Ô∏è Enter ride ID");
      const res = await fetch(`${BASE_URL}/rides/${rideId}/assign`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await res.json();
      log(`üîç Ride ${rideId}: ` + JSON.stringify(data, null, 2));
    }
  </script>
</body>
</html>
