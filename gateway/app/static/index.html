<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RideNow Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      padding: 20px;
    }
    h1 { color: #333; }
    section {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    input, button {
      margin: 5px;
      padding: 8px;
      font-size: 14px;
    }
    .log {
      background: #111;
      color: #0f0;
      padding: 10px;
      height: 200px;
      overflow-y: auto;
      font-family: monospace;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h1>üöñ RideNow Dashboard</h1>

  <!-- AUTH SECTION -->
  <section>
    <h2>Login / Signup</h2>
    <input id="name" placeholder="Name (for signup)" />
    <input id="email" placeholder="Email" />
    <input id="password" placeholder="Password" type="password" />
    <label><input type="checkbox" id="is_driver" /> Driver?</label><br />
    <button onclick="signup()">Signup</button>
    <button onclick="login()">Login</button>
  </section>

  <!-- RIDE SECTION -->
  <section id="rides-section" style="display:none;">
    <h2>Ride Actions</h2>
    <p><strong>User:</strong> <span id="user-info"></span></p>

    <input id="pickup" placeholder="Pickup location" />
    <input id="dropoff" placeholder="Dropoff location" />
    <button onclick="createRide()">Request Ride</button>

    <button onclick="fetchRides()">View All Rides</button>
    <button onclick="fetchMyRides()">My Rides</button>

    <div id="rides"></div>
  </section>

  <section>
    <h2>WebSocket Logs</h2>
    <div class="log" id="ws-log"></div>
  </section>

  <script>
    const API_URL = "http://localhost:8000";
    let token = null;
    let ws = null;

    function logWs(message) {
      const log = document.getElementById("ws-log");
      log.innerHTML += message + "<br>";
      log.scrollTop = log.scrollHeight;
    }

    async function signup() {
      const res = await fetch(`${API_URL}/signup`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name: document.getElementById("name").value,
          email: document.getElementById("email").value,
          password: document.getElementById("password").value,
          is_driver: document.getElementById("is_driver").checked
        })
      });
      const data = await res.json();
      alert(res.ok ? "Signup successful" : data.detail);
    }

    async function login() {
      const res = await fetch(`${API_URL}/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email: document.getElementById("email").value,
          password: document.getElementById("password").value
        })
      });
      const data = await res.json();
      if (res.ok) {
        token = data.access_token;
        document.getElementById("rides-section").style.display = "block";
        document.getElementById("user-info").innerText = document.getElementById("email").value;
        connectWs();
      } else {
        alert(data.detail);
      }
    }

    async function createRide() {
      const res = await fetch(`${API_URL}/rides/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({
          pickup: document.getElementById("pickup").value,
          dropoff: document.getElementById("dropoff").value
        })
      });
      const data = await res.json();
      alert(res.ok ? "Ride created!" : data.detail);
    }

    async function fetchRides() {
      const res = await fetch(`${API_URL}/rides/`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const data = await res.json();
      displayRides(data);
    }

    async function fetchMyRides() {
      const res = await fetch(`${API_URL}/rides/my`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const data = await res.json();
      displayRides(data);
    }

    function displayRides(rides) {
      const container = document.getElementById("rides");
      container.innerHTML = "<h3>Rides:</h3>";
      rides.forEach(r => {
        const div = document.createElement("div");
        div.innerHTML = `#${r.id} | ${r.pickup} ‚Üí ${r.dropoff} | Status: ${r.status}`;
        container.appendChild(div);
      });
    }

    function connectWs() {
      ws = new WebSocket(`ws://localhost:8000/ws?token=${token}`);
      ws.onopen = () => logWs("‚úÖ WebSocket connected");
      ws.onmessage = (e) => logWs(`üì© ${e.data}`);
      ws.onclose = () => logWs("‚ùå WebSocket closed");
      ws.onerror = (err) => logWs(`‚ö†Ô∏è WebSocket error: ${err.message}`);
    }
  </script>
</body>
</html>
